<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vincent's Drinking Around the World | EPCOT Adventure</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Google Maps API will be loaded dynamically from config.js -->
    <style>
        :root {
            --purple-primary: #6B5B95;
            --purple-deep: #4A4063;
            --orange-primary: #FF6B35;
            --orange-light: #FF8C42;
            --gold: #F4A261;
            --grey-overlay: rgba(74, 64, 99, 0.85);
            --cream: #FFF5EB;
            --success: #52B788;
            --shadow: rgba(107, 91, 149, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(180deg, var(--purple-primary) 0%, var(--purple-deep) 100%);
            color: #333;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        /* HERO HEADER */
        .hero-header {
            background: linear-gradient(135deg, var(--purple-deep) 0%, var(--purple-primary) 50%, #8B7BA8 100%);
            position: relative;
            /* overflow: hidden removed ‚Äî was clipping the brand-badge logo */
            padding: 0;
        }

        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(74, 64, 99, 0.6) 100%);
            z-index: 1;
        }

        .hero-wrapper {
            position: relative;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            padding: 40px 30px 30px 130px;
            color: white;
            min-height: 120px;
        }

        .brand-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 90px;
            height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
            z-index: 10;
        }

        .brand-logo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }

        .hero-title-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .trip-label {
            font-size: 12px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: 15px;
            font-weight: 700;
        }

        .hero-title {
            font-family: 'Playfair Display', serif;
            font-size: 56px;
            font-weight: 900;
            letter-spacing: 2px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-light), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .hero-subtitle {
            font-size: 14px;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: white;
            font-weight: 400;
            opacity: 0.95;
        }

        .hero-curve {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background: white;
            clip-path: ellipse(100% 100% at 50% 100%);
        }

        .date-banner {
            background: var(--grey-overlay);
            padding: 15px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-size: 13px;
            color: white;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .date-banner span {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* PROGRESS DASHBOARD */
        .progress-dashboard {
            background: linear-gradient(135deg, var(--cream) 0%, white 100%);
            padding: 25px;
            border-bottom: 3px solid var(--orange-primary);
        }

        .progress-bar-wrapper {
            margin-bottom: 25px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 700;
            color: var(--purple-deep);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-bar-track {
            height: 16px;
            background: #E8E8E8;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--purple-primary), var(--orange-primary), var(--gold));
            width: 0%;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-bar-inner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: white;
            border: 2px solid var(--purple-primary);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--orange-primary), var(--gold));
        }

        .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px var(--shadow);
            border-color: var(--orange-primary);
        }

        .stat-emoji {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 42px;
            font-weight: 700;
            color: var(--purple-deep);
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--purple-primary);
            font-weight: 700;
        }

        /* TAB NAVIGATION */
        .tab-bar {
            display: flex;
            background: white;
            border-bottom: 3px solid var(--purple-primary);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 20px;
            border: none;
            background: white;
            font-family: 'Lato', sans-serif;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--purple-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0;
            background: linear-gradient(90deg, var(--orange-primary), var(--gold));
            transition: height 0.3s ease;
        }

        .tab-btn:hover {
            background: var(--cream);
        }

        .tab-btn.active {
            color: var(--orange-primary);
            background: var(--cream);
        }

        .tab-btn.active::after {
            height: 4px;
        }

        .tab-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 8px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* GOOGLE MAP */
        .map-wrapper {
            position: relative;
        }

        #googleMap {
            width: 100%;
            height: 65vh;
            min-height: 500px;
        }

        .map-overlay-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            z-index: 10;
            min-width: 200px;
        }

        .map-control-title {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--purple-deep);
            margin-bottom: 15px;
        }

        .map-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid var(--purple-primary);
            color: var(--purple-primary);
            border-radius: 12px;
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-btn:hover {
            background: var(--purple-primary);
            color: white;
            transform: translateX(-2px);
        }

        .map-btn.active {
            background: linear-gradient(135deg, var(--orange-primary), var(--gold));
            border-color: var(--orange-primary);
            color: white;
        }

        /* MAP LEGEND */
        .map-legend {
            background: white;
            padding: 30px;
            border-top: 4px solid var(--orange-primary);
        }

        .legend-header {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--purple-deep);
            margin-bottom: 20px;
            text-align: center;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .legend-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--cream);
            border-radius: 12px;
            border-left: 4px solid var(--purple-primary);
        }

        .legend-marker {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .legend-marker.completed {
            background: var(--success);
            color: white;
        }

        .legend-marker.active {
            background: linear-gradient(135deg, var(--orange-primary), var(--gold));
            color: white;
            animation: pulse 2s infinite;
        }

        .legend-marker.upcoming {
            background: white;
            border: 2px solid var(--purple-primary);
            color: var(--purple-primary);
        }

        .legend-marker.reservation {
            background: var(--gold);
            color: white;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(255, 107, 53, 0);
            }
        }

        .legend-info {
            flex: 1;
        }

        .legend-label {
            font-weight: 700;
            font-size: 14px;
            color: var(--purple-deep);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* CHALLENGE LIST */
        .challenges-container {
            padding: 30px 20px;
            background: linear-gradient(180deg, white 0%, var(--cream) 100%);
        }

        .challenge-item {
            background: white;
            border: 3px solid #E8E8E8;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .challenge-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, var(--purple-primary), var(--orange-primary));
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .challenge-item:hover::before {
            transform: scaleY(1);
        }

        .challenge-item.completed {
            border-color: var(--success);
            background: linear-gradient(135deg, #F0FFF4 0%, white 100%);
        }

        .challenge-item.active {
            border-color: var(--orange-primary);
            background: linear-gradient(135deg, #FFF5EB 0%, white 100%);
            box-shadow: 0 12px 40px rgba(255, 107, 53, 0.3);
            transform: translateY(-4px);
        }

        .challenge-item.active::before {
            transform: scaleY(1);
            background: linear-gradient(180deg, var(--orange-primary), var(--gold));
        }

        .challenge-top {
            display: flex;
            gap: 25px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .challenge-emoji {
            font-size: 56px;
            flex-shrink: 0;
        }

        .challenge-main {
            flex: 1;
        }

        .challenge-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .challenge-name {
            font-family: 'Playfair Display', serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--purple-deep);
            line-height: 1.3;
        }

        .challenge-time-badge {
            background: linear-gradient(135deg, var(--orange-primary), var(--gold));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .challenge-desc {
            color: #555;
            line-height: 1.8;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .tag-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tag-pill {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tag-pill.drink {
            background: linear-gradient(135deg, #FFF5E6, #FFE4B3);
            color: #D97706;
            border: 2px solid #FCD34D;
        }

        .tag-pill.photo {
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
            color: #1E40AF;
            border: 2px solid #93C5FD;
        }

        .tag-pill.food {
            background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
            color: #065F46;
            border: 2px solid #6EE7B7;
        }

        .tag-pill.reservation {
            background: linear-gradient(135deg, #FCE7F3, #FBCFE8);
            color: #9F1239;
            border: 2px solid #F9A8D4;
        }

        .tips-panel {
            background: linear-gradient(135deg, var(--cream), white);
            border-left: 5px solid var(--orange-primary);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .tips-heading {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--purple-deep);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tips-items {
            list-style: none;
        }

        .tips-items li {
            padding-left: 30px;
            position: relative;
            margin-bottom: 10px;
            color: #555;
            line-height: 1.6;
            font-size: 15px;
        }

        .tips-items li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: var(--orange-primary);
            font-weight: 700;
            font-size: 18px;
        }

        .check-action {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .check-box {
            width: 60px;
            height: 60px;
            border: 4px solid var(--purple-primary);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            background: white;
            flex-shrink: 0;
        }

        .check-box:hover {
            transform: scale(1.1) rotate(5deg);
            border-color: var(--orange-primary);
        }

        .check-box.checked {
            background: linear-gradient(135deg, var(--success), #34D399);
            border-color: var(--success);
            animation: checkPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .check-box.checked::after {
            content: '‚úì';
            color: white;
            font-size: 36px;
            font-weight: 900;
        }

        @keyframes checkPop {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.3) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        /* CELEBRATION MODAL */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(74, 64, 99, 0.95);
            backdrop-filter: blur(10px);
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 30px;
            max-width: 550px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            position: relative;
            margin: auto 0;
            animation: celebrationPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            border: 4px solid var(--orange-primary);
        }


        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes celebrationPop {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .modal-confetti {
            font-size: 70px;
            margin-bottom: 15px;
            animation: float 2s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(-5deg);
            }
            50% {
                transform: translateY(-20px) rotate(5deg);
            }
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 900;
            color: var(--purple-deep);
            margin-bottom: 12px;
        }

        .modal-text {
            font-size: 17px;
            color: #555;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-cta {
            background: linear-gradient(135deg, var(--orange-primary), var(--gold));
            color: white;
            border: none;
            padding: 18px 45px;
            border-radius: 30px;
            font-family: 'Lato', sans-serif;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 25px rgba(255, 107, 53, 0.5);
        }

        .modal-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 35px rgba(255, 107, 53, 0.7);
        }

        /* STATS MODAL */
        .stats-modal-box {
            max-height: 80vh;
            overflow-y: auto;
            max-width: 650px;
        }

        .stats-modal-content {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            padding: 10px;
        }

        .stats-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .stats-item.completed {
            border-left-color: var(--success);
            background: #f0f9f4;
        }

        .stats-item.pending {
            border-left-color: #ddd;
            opacity: 0.6;
        }

        .stats-item-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .stats-item-emoji {
            font-size: 28px;
        }

        .stats-item-text {
            text-align: left;
        }

        .stats-item-name {
            font-weight: 700;
            color: var(--purple-deep);
            font-size: 16px;
            margin-bottom: 3px;
        }

        .stats-item-detail {
            font-size: 13px;
            color: #666;
        }

        .stats-item-status {
            font-size: 24px;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close-btn:hover {
            background: #f0f0f0;
            color: var(--purple-deep);
            transform: rotate(90deg);
        }

        /* COMPLETION CELEBRATION MODAL */
        .completion-modal-box {
            max-width: 700px;
            background: linear-gradient(135deg, var(--cream) 0%, white 100%);
            border: 5px solid var(--gold);
            position: relative;
            overflow-y: auto;
        }

        .completion-title {
            font-size: 42px;
            background: linear-gradient(135deg, var(--purple-deep), var(--purple-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .completion-subtitle {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--orange-primary);
            margin-bottom: 20px;
        }

        .completion-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(107, 91, 149, 0.2);
        }

        .completion-stat-item {
            text-align: center;
        }

        .completion-stat-emoji {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .completion-stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 42px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--purple-deep), var(--orange-primary), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            margin-bottom: 6px;
        }

        .completion-stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--purple-primary);
            font-weight: 700;
        }

        .completion-message {
            font-size: 15px;
            color: var(--purple-deep);
            line-height: 1.6;
            margin: 15px 0;
            font-weight: 600;
        }

        /* CONFETTI ANIMATION */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 2001;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--gold);
            top: -10px;
            opacity: 0;
            /* Duration is set dynamically via inline style (3-5s) */
            animation: confettiFall ease-in forwards;
        }

        @keyframes confettiFall {
            0% {
                opacity: 1;
                top: -10px;
                transform: translateX(0) rotateZ(0deg);
            }
            100% {
                opacity: 0.7;
                top: 100vh;
                transform: translateX(var(--confetti-x)) rotateZ(720deg);
            }
        }

        .stat-box {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(107, 91, 149, 0.3);
        }

        /* FOOTER */
        .app-footer {
            background: var(--grey-overlay);
            padding: 30px;
            text-align: center;
        }

        .reset-action {
            background: white;
            color: var(--purple-deep);
            border: 3px solid white;
            padding: 15px 40px;
            border-radius: 30px;
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .reset-action:hover {
            background: transparent;
            color: white;
            transform: scale(1.05);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 42px;
            }

            .stats-dashboard {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-value {
                font-size: 36px;
            }

            .challenge-name {
                font-size: 20px;
            }

            .challenge-emoji {
                font-size: 40px;
            }

            .map-overlay-controls {
                top: 10px;
                right: 10px;
                padding: 15px;
                min-width: 150px;
            }

            .legend-grid {
                grid-template-columns: 1fr;
            }

            /* Map Info Window Optimization - !important needed to override Google Maps inline styles */
            .gm-style-iw-c {
                max-width: 90% !important;
            }

            .gm-style-iw-d {
                overflow: auto !important;
            }

            .google-map-info-window {
                max-width: 90% !important;
                font-size: 14px !important;
            }

            .google-map-info-window > div {
                flex-direction: column !important;
            }

            /* Touch-friendly checkbox size - !important to ensure minimum touch target */
            .map-check-box {
                min-width: 44px !important;
                min-height: 44px !important;
            }

            /* Stats Modal Optimization */
            .stats-modal-box {
                width: 95%;
                margin: 0 auto;
                font-size: 14px;
            }

            .stats-modal-content {
                max-height: 60vh;
                overflow-y: auto;
            }

            /* Touch-friendly buttons and checkboxes */
            button, .btn, .action-btn {
                min-height: 44px;
                padding: 12px 24px;
                font-size: 16px;
            }

            /* Brand badge size adjustment for mobile */
            .brand-badge {
                width: 60px;
                height: 60px;
                top: 10px;
                left: 10px;
            }

            /* Hero content padding adjustment */
            .hero-content {
                padding: 20px 20px 20px 80px;
            }

            /* Challenge card optimization */
            .challenge-card {
                padding: 15px;
            }

            /* Stats items optimization */
            .stats-item {
                padding: 12px 15px;
                margin: 8px 0;
            }

            /* Challenge list checkbox fix */
            .challenge-item {
                padding: 20px 15px;
            }

            .challenge-top {
                gap: 12px;
            }

            .challenge-emoji {
                font-size: 32px;
            }

            .check-box {
                width: 48px;
                height: 48px;
            }

            /* Modal sizing for mobile */
            .modal-box {
                padding: 20px 16px;
            }

            .completion-modal-box {
                max-width: 95vw;
            }

            .completion-stats {
                gap: 8px;
                padding: 12px;
            }

            .completion-stat-value {
                font-size: 30px;
            }

            .completion-stat-emoji {
                font-size: 26px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HERO HEADER -->
        <div class="hero-wrapper">
            <div class="hero-header">
                <div class="hero-overlay"></div>
                <!-- LOGO inside hero-header ‚Äî overflow:hidden removed from hero-header so nothing clips it -->
                <div class="brand-badge">
                    <img src="data:image/png;base64,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" alt="Magical Doc Sarah Adventures" class="brand-logo">
                </div>
                <div class="hero-content">
                    <div class="hero-title-section">
                        <div class="trip-label">Cannizzaro Family Trip To</div>
                        <h1 class="hero-title">EPCOT</h1>
                        <p class="hero-subtitle">Vincent's Drinking Around the World Birthday</p>
                    </div>
                </div>
                <div class="hero-curve"></div>
            </div>
        </div>

        <div class="date-banner">
            <span>üìÖ March 8, 2026</span>
            <span>|</span>
            <span>üéÇ 21st Birthday Celebration</span>
        </div>

        <!-- PROGRESS DASHBOARD -->
        <div class="progress-dashboard">
            <div class="progress-bar-wrapper">
                <div class="progress-label">
                    <span>Journey Progress</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar-track">
                    <div class="progress-bar-inner" id="progressBar"></div>
                </div>
            </div>

            <div class="stats-dashboard">
                <div class="stat-box" onclick="showStatsModal('completed')" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showStatsModal('completed')}" aria-label="View completed challenges details">
                    <div class="stat-emoji">‚úÖ</div>
                    <div class="stat-value" id="completedStat">0</div>
                    <div class="stat-title">Completed</div>
                </div>
                <div class="stat-box" onclick="showStatsModal('countries')" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showStatsModal('countries')}" aria-label="View countries progress details">
                    <div class="stat-emoji">üåç</div>
                    <div class="stat-value" id="countriesStat">0</div>
                    <div class="stat-title">Countries</div>
                </div>
                <div class="stat-box" onclick="showStatsModal('photos')" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showStatsModal('photos')}" aria-label="View photos progress details">
                    <div class="stat-emoji">üì∏</div>
                    <div class="stat-value" id="photosStat">0</div>
                    <div class="stat-title">Photos</div>
                </div>
            </div>
        </div>

        <!-- TAB NAVIGATION -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('map')">
                <span class="tab-icon">üó∫Ô∏è</span>
                <span>Interactive Map</span>
            </button>
            <button class="tab-btn" onclick="switchTab('list')">
                <span class="tab-icon">üìã</span>
                <span>Challenge List</span>
            </button>
        </div>

        <!-- MAP TAB -->
        <div id="mapTab" class="tab-panel active">
            <div class="map-wrapper">
                <div id="googleMap"></div>
                <div class="map-overlay-controls">
                    <div class="map-control-title">Quick Nav</div>
                    <button class="map-btn" onclick="focusOnNextStop()">üìç Next Stop</button>
                    <button class="map-btn" onclick="showAllMarkers()">üåç View All</button>
                    <button class="map-btn" onclick="focusOnReservations()">üçΩÔ∏è Reservations</button>
                </div>
            </div>

            <div class="map-legend">
                <div class="legend-header">Map Legend</div>
                <div class="legend-grid">
                    <div class="legend-card">
                        <div class="legend-marker completed">‚úì</div>
                        <div class="legend-info">
                            <div class="legend-label">Completed</div>
                        </div>
                    </div>
                    <div class="legend-card">
                        <div class="legend-marker active">üéØ</div>
                        <div class="legend-info">
                            <div class="legend-label">Next Up</div>
                        </div>
                    </div>
                    <div class="legend-card">
                        <div class="legend-marker upcoming">‚óã</div>
                        <div class="legend-info">
                            <div class="legend-label">Upcoming</div>
                        </div>
                    </div>
                    <div class="legend-card">
                        <div class="legend-marker reservation">üçΩÔ∏è</div>
                        <div class="legend-info">
                            <div class="legend-label">Reservation</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LIST TAB -->
        <div id="listTab" class="tab-panel">
            <div class="challenges-container" id="challengesList">
                <!-- Challenges will be populated by JavaScript -->
            </div>
        </div>

        <!-- FOOTER -->
        <div class="app-footer">
            <button class="reset-action" onclick="resetAll()">Reset Progress</button>
        </div>
    </div>

    <!-- CELEBRATION MODAL -->
    <div class="modal-backdrop" id="celebrationModal">
        <div class="modal-box">
            <div class="modal-confetti">üéâ</div>
            <h2 class="modal-title">Challenge Complete!</h2>
            <p class="modal-text" id="celebrationText"></p>
            <button class="modal-cta" onclick="closeModal()">Continue Adventure!</button>
        </div>
    </div>

    <!-- COMPLETION CELEBRATION MODAL -->
    <div class="modal-backdrop" id="completionModal">
        <div class="modal-box completion-modal-box">
            <div class="confetti-container" id="confettiContainer"></div>
            <div class="modal-confetti">üéâüéä</div>
            <h2 class="modal-title completion-title">Vincent's 21st Birthday</h2>
            <h3 class="completion-subtitle">EPCOT Adventure Complete!</h3>
            <div class="completion-stats">
                <div class="completion-stat-item">
                    <div class="completion-stat-emoji">‚úÖ</div>
                    <div class="completion-stat-value" id="completionChallenges">0</div>
                    <div class="completion-stat-label">Challenges</div>
                </div>
                <div class="completion-stat-item">
                    <div class="completion-stat-emoji">üåç</div>
                    <div class="completion-stat-value" id="completionCountries">0</div>
                    <div class="completion-stat-label">Countries</div>
                </div>
                <div class="completion-stat-item">
                    <div class="completion-stat-emoji">üì∏</div>
                    <div class="completion-stat-value" id="completionPhotos">0</div>
                    <div class="completion-stat-label">Photos</div>
                </div>
            </div>
            <p class="completion-message">üéä What an incredible adventure! You've explored every corner of EPCOT and made unforgettable memories! üéä</p>
            <button class="modal-cta" onclick="closeCompletionModal()">Celebrate Again! üéâ</button>
        </div>
    </div>

    <!-- STATS DETAIL MODAL -->
    <div class="modal-backdrop" id="statsModal" role="dialog" aria-modal="true" aria-labelledby="statsModalTitle">
        <div class="modal-box stats-modal-box">
            <button class="modal-close-btn" onclick="closeStatsModal()" aria-label="Close statistics modal">√ó</button>
            <div class="modal-confetti" id="statsModalEmoji">üìä</div>
            <h2 class="modal-title" id="statsModalTitle">Statistics</h2>
            <div class="stats-modal-content" id="statsModalContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <button class="modal-cta" onclick="closeStatsModal()">Close</button>
        </div>
    </div>

    <!-- Load configuration first -->
    <script src="config.js"></script>

    <!-- Firebase SDK (compat version - no module bundler needed) -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

    <script>
        // Load Google Maps API dynamically
        function loadGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                if (typeof google !== 'undefined' && google.maps) {
                    resolve();
                    return;
                }

                const apiKey = (typeof CONFIG !== 'undefined' && CONFIG.GOOGLE_MAPS_API_KEY)
                    ? CONFIG.GOOGLE_MAPS_API_KEY
                    : '';

                if (!apiKey || apiKey === 'YOUR_API_KEY_HERE') {
                    reject(new Error('Google Maps API key not configured. Please copy config.example.js to config.js and add your API key. See README.md for setup instructions.'));
                    return;
                }

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
                script.async = true;
                script.defer = true;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Challenge data with actual EPCOT coordinates
        const challenges = [
            {
                id: 'arrival',
                name: 'Spaceship Earth Arrival Photo',
                emoji: 'üì∏',
                time: '10:00 AM',
                description: 'Take a group "before" photo in front of Spaceship Earth - the perfect start to Vincent\'s 21st birthday!',
                tags: ['photo'],
                celebration: 'Perfect start! Now head to Mexico for the tequila experience! üá≤üáΩ',
                lat: 28.372834329010193,
                lng: -81.54942485947093,
                country: null
            },
            {
                id: 'lacava',
                name: 'La Cava del Tequila Experience',
                emoji: 'üá≤üáΩ',
                time: '10:45 AM',
                description: '<strong>RESERVATION:</strong> Adults only (Vince, Vincent, Ally). Kids: Gran Fiesta Tour!',
                tags: ['reservation', 'drink'],
                tips: [
                    'Arrive 5 minutes early',
                    'This is EPCOT\'s best bar!',
                    'Try the famous Avocado Margarita',
                    'Photo inside the pyramid marketplace'
                ],
                celebration: 'Salud! Amazing tequila experience! ü•É',
                lat: 28.3715105349719,
                lng: -81.5475123414328,
                country: 'mexico'
            },
            {
                id: 'mexico-photo',
                name: 'Mexico Pyramid Photo',
                emoji: 'üì∏',
                time: '10:45 AM',
                description: 'Get a group photo outside the pyramid!',
                tags: ['photo'],
                celebration: '¬°Perfecto! Beautiful photo captured! üì∑',
                lat: 28.3716,
                lng: -81.5474,
                country: 'mexico'
            },
            {
                id: 'norway-drink',
                name: 'Norway - Viking Territory',
                emoji: 'üá≥üá¥',
                time: '12:15 PM',
                description: 'Adults: Viking Coffee or Nordic draft beer. Everyone: School bread from Kringla Bakeri and Frozen Ever After ride!',
                tags: ['drink', 'food'],
                tips: [
                    'Norwegian beers more authentic than coffee',
                    'Kids love Frozen Ever After',
                    'Chocolate chip cookies surprisingly amazing!'
                ],
                celebration: 'Skal! Norway conquered! ‚öîÔ∏è',
                lat: 28.370732720514702,
                lng: -81.54665537177027,
                country: 'norway'
            },
            {
                id: 'norway-photo',
                name: 'Norway Viking Ship Photo',
                emoji: 'üì∏',
                time: '12:15 PM',
                description: 'PhotoPass at Viking ship with Stave Church backdrop - classic EPCOT photo!',
                tags: ['photo'],
                celebration: 'Epic Viking photo! üõ°Ô∏è',
                lat: 28.3705676702852,
                lng: -81.54703053192117,
                country: 'norway'
            },
            {
                id: 'china-drink',
                name: 'China - Tea & Temples',
                emoji: 'üá®üá≥',
                time: '1:00 PM',
                description: 'Adults: TsingTao beer or plum wine from the Lotus Blossom Cafe. Everyone: Snacks from Joy of Tea. Watch Reflections of China film (15 min AC break!)',
                tags: ['drink', 'food'],
                celebration: 'Ganbei! China complete! üèÆ',
                lat: 28.370089891857646,
                lng: -81.54570759875746,
                country: 'china'
            },
            {
                id: 'china-photo',
                name: 'Temple of Heaven Photo',
                emoji: 'üì∏',
                time: '1:00 PM',
                description: 'PhotoPass at beautiful Temple of Heaven architecture!',
                tags: ['photo'],
                celebration: 'Stunning Temple photo! üèØ',
                lat: 28.37009857875734,
                lng: -81.54687256975235,
                country: 'china'
            },
            {
                id: 'biergarten',
                name: 'Biergarten Restaurant',
                emoji: 'üá©üá™',
                time: '2:00 PM',
                description: '<strong>RESERVATION:</strong> All 7 guests! Buffet with German beers and live entertainment. Try the Beer Flight or Sch√∂fferhofer Grapefruit Hefeweizen!',
                tags: ['reservation', 'drink', 'food'],
                tips: [
                    'Beer flight lets you try 4 varieties',
                    'Don\'t miss pretzel bread pudding dessert',
                    'Live music and entertainment!',
                    'Karamell-K√ºche has Werther\'s treats'
                ],
                celebration: 'Prost! What a feast! üç∫',
                lat: 28.36811494075977,
                lng: -81.54697869192768,
                country: 'germany'
            },
            {
                id: 'germany-photo',
                name: 'Germany Clock Tower Photo',
                emoji: 'üì∏',
                time: '2:00 PM',
                description: 'Family photo at clock tower with Bavarian architecture!',
                tags: ['photo'],
                celebration: 'Wunderbar photo! üè∞',
                lat: 28.368348268634175,
                lng: -81.54709654605067,
                country: 'germany'
            },
            {
                id: 'italy-drink',
                name: 'Italy - Wine & Gelato',
                emoji: 'üáÆüáπ',
                time: '3:30 PM',
                description: 'Adults: Italian wine or limoncello. EVERYONE: GELATO from Gelateria Toscana! Try the limoncello float!',
                tags: ['drink', 'food'],
                tips: [
                    'Tutto Gusto has 200+ wine bottles',
                    'Gelato is a must in Florida heat',
                    'Try affogato - gelato with espresso'
                ],
                celebration: 'Bellissimo! Italy was delicious! üç¶',
                lat: 28.367974420093205,
                lng: -81.54851607352767,
                country: 'italy'
            },
            {
                id: 'italy-photo',
                name: 'St. Mark\'s Square Photo',
                emoji: 'üì∏',
                time: '3:30 PM',
                description: 'PhotoPass at gorgeous Italian architecture with bell tower!',
                tags: ['photo'],
                celebration: 'Magnifico! Beautiful backdrop! üáÆüáπ',
                lat: 28.36760841605787,
                lng: -81.54816314330053,
                country: 'italy'
            },
            {
                id: 'usa-drink',
                name: 'The American Adventure',
                emoji: 'üá∫üá∏',
                time: '4:15 PM',
                description: 'Adults: Craft beer or bourbon. Everyone: Watch American Adventure show (30 min) - great AC break! Regal Eagle has BBQ.',
                tags: ['drink', 'food'],
                celebration: 'USA! USA! Home country complete! ü¶Ö',
                lat: 28.367475323368375,
                lng: -81.54899084871421,
                country: 'usa'
            },
            {
                id: 'usa-photo',
                name: 'Colonial Building Photo',
                emoji: 'üì∏',
                time: '4:15 PM',
                description: 'PhotoPass at stately Colonial building!',
                tags: ['photo'],
                celebration: 'Patriotic photo captured! üá∫üá∏',
                lat: 28.36760524128363,
                lng: -81.54937661691916,
                country: 'usa'
            },
            {
                id: 'japan-drink',
                name: 'Japan - Sake & Sushi',
                emoji: 'üáØüáµ',
                time: '5:00 PM',
                description: 'Adults: Kirin Frozen beer or sake from Mitsukoshi. Everyone: Snacks from Katsura Grill. Kids love Japanese candy and Pokemon!',
                tags: ['drink', 'food'],
                tips: [
                    'Sake Bar hidden in Mitsukoshi store',
                    'Kirin Frozen has icy foam',
                    'Check for Taiko drummer performance'
                ],
                celebration: 'Kampai! Japan was amazing! üóæ',
                lat: 28.367518789424228,
                lng: -81.55066614706807,
                country: 'japan'
            },
            {
                id: 'japan-photo',
                name: 'Torii Gate Photo - ICONIC!',
                emoji: 'üì∏',
                time: '5:00 PM',
                description: 'THE most iconic EPCOT photo! Red Torii gate over the lagoon. PhotoPass here!',
                tags: ['photo'],
                celebration: 'That\'s THE classic EPCOT photo! üì∏‚ú®',
                lat: 28.367781746882883,
                lng: -81.55055970965896,
                country: 'japan'
            },
            {
                id: 'morocco-drink',
                name: 'Morocco - Marketplace Magic',
                emoji: 'üá≤üá¶',
                time: '5:45 PM',
                description: 'Adults: Casablanca beer or frozen mint tea cocktail at Oasis Sweets & Sips. Everyone: Explore the maze-like marketplace - kids love the shops!',
                tags: ['drink', 'food'],
                celebration: 'Morocco explored! Hidden gem! üïå',
                lat: 28.36819103405243,
                lng: -81.55171686420277,
                country: 'morocco'
            },
            {
                id: 'morocco-photo',
                name: 'Morocco Marketplace Photo',
                emoji: 'üì∏',
                time: '5:45 PM',
                description: 'Colorful archways with beautiful hand-placed tiles!',
                tags: ['photo'],
                celebration: 'Stunning Moroccan backdrop! üé®',
                lat: 28.36836897125652,
                lng: -81.55160797373034,
                country: 'morocco'
            },
            {
                id: 'france-drink',
                name: 'France - Champagne & Pastries',
                emoji: 'üá´üá∑',
                time: '6:30 PM',
                description: 'Adults: Champagne or French wine from La Maison du Vin. Everyone: Pastries from Les Halles Boulangerie-Patisserie! If time, ride Remy\'s Ratatouille Adventure.',
                tags: ['drink', 'food'],
                celebration: 'Tr√®s bien! French sophistication! ü•ê',
                lat: 28.368703713300352,
                lng: -81.55287163203667,
                country: 'france'
            },
            {
                id: 'france-photo',
                name: 'Eiffel Tower Photo',
                emoji: 'üì∏',
                time: '6:30 PM',
                description: 'Classic EPCOT photo with Eiffel Tower! Golden hour lighting perfect!',
                tags: ['photo'],
                celebration: 'Ooh la la! Perfect Eiffel Tower shot! üóº',
                lat: 28.36939544585264,
                lng: -81.55220547728484,
                country: 'france'
            },
            {
                id: 'uk-drink',
                name: 'United Kingdom - Fish & Chips',
                emoji: 'üá¨üáß',
                time: '7:15 PM',
                description: 'Adults: Pint at Rose & Crown Pub or scotch flight. Everyone: Fish and chips from Yorkshire (BEST in EPCOT!). Great lagoon views.',
                tags: ['drink', 'food'],
                tips: [
                    'Yorkshire fish & chips legendary',
                    'Rose & Crown has best lagoon seating',
                    'Check for British band performances'
                ],
                celebration: 'Cheers mate! UK conquered! üá¨üáß',
                lat: 28.370304787669554,
                lng: -81.55179947438666,
                country: 'uk'
            },
            {
                id: 'uk-photo',
                name: 'Red Phone Booth Photo',
                emoji: 'üì∏',
                time: '7:15 PM',
                description: 'Classic red phone booth - everyone loves this fun photo!',
                tags: ['photo'],
                celebration: 'Brilliant photo! ‚òéÔ∏è',
                lat: 28.37081087631685,
                lng: -81.55168259476446,
                country: 'uk'
            },
            {
                id: 'canada-drink',
                name: 'Canada - Maple Magic',
                emoji: 'üá®üá¶',
                time: '7:45 PM',
                description: 'Quick stop! Adults: Ottawa Apple from popcorn cart (whiskey, maple, apple, cranberry - hidden gem!). Maple popcorn!',
                tags: ['drink', 'food'],
                celebration: 'Eh! Canada tastes sweet! üçÅ',
                lat: 28.371582217326296,
                lng: -81.55105337444732,
                country: 'canada'
            },
            {
                id: 'canada-photo',
                name: 'Canada Gardens Photo',
                emoji: 'üì∏',
                time: '7:45 PM',
                description: 'PhotoPass at beautiful Canadian gardens with Rocky Mountains!',
                tags: ['photo'],
                celebration: 'Beautiful Canadian scenery! üèîÔ∏è',
                lat: 28.37160354264743,
                lng: -81.55129253655585,
                country: 'canada'
            },
            {
                id: 'lecellier',
                name: 'Le Cellier - BIRTHDAY DINNER!',
                emoji: 'üéÇ',
                time: '8:00 PM',
                description: '<strong>RESERVATION:</strong> All 7 guests! Ask to have your tables together. They will usually accommodate. Birthday celebration dinner! Signature steakhouse. Request birthday acknowledgment!',
                tags: ['reservation', 'food'],
                tips: [
                    'Cheddar cheese soup legendary - must try!',
                    'Tell server it\'s Vincent\'s 21st birthday',
                    'Ice wine is Canadian specialty',
                    'Make sure Vincent wears birthday button!'
                ],
                celebration: 'HAPPY 21ST BIRTHDAY VINCENT! üéâüéÇüéä',
                lat: 28.371558483971512,
                lng: -81.55161402011376,
                country: 'canada'
            },
            {
                id: 'fireworks',
                name: 'Luminous Fireworks Show',
                emoji: 'üéÜ',
                time: '9:00 PM',
                description: 'Perfect finale! Watch EPCOT\'s spectacular Luminous fireworks over the lagoon. My favorite spots are in Italy/America to get a straight view of Spaceship Earth and the fireworks or in France while sipping champagne!',
                tags: ['photo'],
                celebration: 'EPIC DAY COMPLETE! Vincent\'s 21st was LEGENDARY! üéâüçπüåç',
                lat: 28.36819547685581,
                lng: -81.54847620969086,
                country: null
            }
        ];

        // State management
        let completed = JSON.parse(localStorage.getItem('vincentChallenges') || '[]');
        let map, markers = [];

        // ‚îÄ‚îÄ Firebase real-time sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let db = null;
        let syncEnabled = false;
        let firebaseInitialized = false;

        function initFirebase() {
            try {
                const cfg = (typeof CONFIG !== 'undefined') ? CONFIG : {};
                if (!cfg.FIREBASE_DATABASE_URL) {
                    console.warn('Firebase not configured ‚Äî running in local-only mode.');
                    return;
                }
                const firebaseConfig = {
                    apiKey:            cfg.FIREBASE_API_KEY || '',
                    authDomain:        cfg.FIREBASE_AUTH_DOMAIN || '',
                    databaseURL:       cfg.FIREBASE_DATABASE_URL,
                    projectId:         cfg.FIREBASE_PROJECT_ID || '',
                    appId:             cfg.FIREBASE_APP_ID || ''
                };

                // Only initialize once (compat SDK adds to window.firebase)
                const app = firebase.apps.length
                    ? firebase.apps[0]
                    : firebase.initializeApp(firebaseConfig);
                db = firebase.database(app);
                syncEnabled = true;

                const completedRef = db.ref('session/completed');

                // Listen for remote changes ‚Üí re-render on ALL devices
                completedRef.on('value', (snapshot) => {
                    const remote = snapshot.val();
                    if (remote !== null && Array.isArray(remote)) {
                        // Firebase has data ‚Äî use it as source of truth
                        completed = remote;
                    } else if (remote === null) {
                        // Firebase is empty ‚Äî promote any localStorage data
                        const local = JSON.parse(localStorage.getItem('vincentChallenges') || '[]');
                        if (local.length > 0) {
                            completed = local;
                            completedRef.set(completed); // seeds all other devices
                            return; // onValue will fire again with the promoted data
                        } else {
                            completed = [];
                        }
                    }
                    localStorage.setItem('vincentChallenges', JSON.stringify(completed));
                    renderChallenges();
                    updateStats();
                });

            } catch (err) {
                console.error('Firebase init failed ‚Äî falling back to localStorage only.', err);
                syncEnabled = false;
            }
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // Initialize
        async function init() {
            // Always render challenges and stats, even if map fails
            renderChallenges();
            updateStats();

            // Start Firebase sync on first load only
            if (!firebaseInitialized) {
                firebaseInitialized = true;
                initFirebase();
            }

            // Try to load and initialize map (map is optional)
            try {
                await loadGoogleMapsAPI();
                initMap();
            } catch (error) {
                console.error('Failed to load Google Maps:', error);
                // Show a non-intrusive error message in the map container
                const mapContainer = document.getElementById('googleMap');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; color: #666; padding: 20px; text-align: center;">
                            <div>
                                <div style="font-size: 48px; margin-bottom: 10px;">üó∫Ô∏è</div>
                                <div style="font-weight: bold; margin-bottom: 10px;">Map Not Available</div>
                                <div style="font-size: 14px;">The Google Maps API failed to load. Please check your config.js file and ensure you have a valid API key.</div>
                                <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">The challenge list below is still fully functional!</div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Initialize Google Map
        function initMap() {
            const epcotCenter = { lat: 28.3730, lng: -81.5470 };

            map = new google.maps.Map(document.getElementById('googleMap'), {
                zoom: 16,
                center: epcotCenter,
                mapTypeId: 'hybrid',
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ],
                disableDefaultUI: false,
                zoomControl: true,
                mapTypeControl: false,
                scaleControl: true,
                streetViewControl: false,
                rotateControl: false,
                fullscreenControl: true
            });

            // Add markers for each challenge
            challenges.forEach((challenge, index) => {
                if (challenge.lat && challenge.lng) {
                    const isCompleted = completed.includes(challenge.id);
                    const isActive = !isCompleted && index === completed.length;
                    const isReservation = challenge.tags.includes('reservation');

                    let icon = {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: isActive ? 12 : 10,
                        fillColor: isCompleted ? '#52B788' : isActive ? '#FF6B35' : isReservation ? '#F4A261' : '#6B5B95',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 3
                    };

                    const marker = new google.maps.Marker({
                        position: { lat: challenge.lat, lng: challenge.lng },
                        map: map,
                        title: challenge.name,
                        icon: icon,
                        animation: isActive ? google.maps.Animation.BOUNCE : null
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="google-map-info-window" style="font-family: Lato, sans-serif; padding: 10px; width: 260px;">
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="font-size: 28px;">${challenge.emoji}</div>
                                        <div>
                                            <h3 style="font-family: Playfair Display, serif; color: #4A4063; margin: 0 0 4px 0; font-size: 16px; line-height: 1.2;">${challenge.name}</h3>
                                            <p style="color: #FF6B35; font-weight: 700; font-size: 12px; margin: 0;">‚è∞ ${challenge.time}</p>
                                        </div>
                                    </div>
                                    <p style="color: #555; font-size: 13px; line-height: 1.4; margin: 0;">${challenge.description.replace(/<[^>]*>/g, '')}</p>
                                    <div
                                        class="map-check-box ${isCompleted ? 'checked' : ''}"
                                        onclick="toggleChallenge('${challenge.id}')"
                                        style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 3px solid ${isCompleted ? '#52B788' : '#6B5B95'};
                                            border-radius: 12px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            cursor: pointer;
                                            background: ${isCompleted ? 'linear-gradient(135deg, #52B788, #34D399)' : 'white'};
                                            transition: all 0.3s ease;
                                            font-size: 20px;
                                            font-weight: 900;
                                            color: white;
                                            gap: 8px;
                                            box-sizing: border-box;
                                        "
                                    >
                                        ${isCompleted
                                            ? '<span style="color:white;">‚úì Done!</span>'
                                            : '<span style="color:#6B5B95; font-weight:700; font-size:14px;">Mark Complete</span>'}
                                    </div>
                                </div>
                            </div>
                        `
                    });

                    marker.addListener('click', () => {
                        markers.forEach(m => m.infoWindow.close());
                        infoWindow.open(map, marker);
                    });

                    markers.push({ marker, infoWindow });
                }
            });
        }

        // Render challenge list
        function renderChallenges() {
            const container = document.getElementById('challengesList');
            container.innerHTML = '';

            challenges.forEach((challenge, index) => {
                const isCompleted = completed.includes(challenge.id);
                const isActive = !isCompleted && index === completed.length;

                const card = document.createElement('div');
                card.className = `challenge-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}`;

                let tipsHTML = '';
                if (challenge.tips && challenge.tips.length > 0) {
                    tipsHTML = `
                        <div class="tips-panel">
                            <div class="tips-heading">üí° Pro Tips</div>
                            <ul class="tips-items">
                                ${challenge.tips.map(tip => `<li>${tip}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="challenge-top">
                        <div class="challenge-emoji">${challenge.emoji}</div>
                        <div class="challenge-main" onclick="navigateToChallenge(${index})" style="cursor: pointer;">
                            <div class="challenge-header-row">
                                <h3 class="challenge-name">${challenge.name}</h3>
                                <div class="challenge-time-badge">‚è∞ ${challenge.time}</div>
                            </div>
                            <p class="challenge-desc">${challenge.description}</p>
                            <div class="tag-row">
                                ${challenge.tags.map(tag => `<span class="tag-pill ${tag}">${tag}</span>`).join('')}
                            </div>
                            ${tipsHTML}
                        </div>
                        <div class="check-action">
                            <div class="check-box ${isCompleted ? 'checked' : ''}" onclick="event.stopPropagation(); toggleChallenge('${challenge.id}')"></div>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Toggle challenge completion
        async function toggleChallenge(id) {
            const challenge = challenges.find(c => c.id === id);
            const index = completed.indexOf(id);
            const wasAdded = index === -1;

            if (wasAdded) {
                completed.push(id);
                // Show celebration immediately ‚Äî before any async re-render
                showCelebration(challenge.celebration);
            } else {
                completed.splice(index, 1);
            }

            // Always keep localStorage in sync as a local fallback
            localStorage.setItem('vincentChallenges', JSON.stringify(completed));

            if (syncEnabled && db) {
                // Write to Firebase ‚Äî the onValue listener fires on ALL devices,
                // triggering renderChallenges() + updateStats() everywhere
                db.ref('session/completed').set(completed);
            } else {
                // No Firebase: re-render locally
                await init();
            }
        }

        // Update statistics
        function updateStats() {
            const totalCompleted = completed.length;
            const totalChallenges = challenges.length;
            const countries = completed.filter(id =>
                challenges.find(c => c.id === id)?.tags.includes('drink')
            ).length;
            const photos = completed.filter(id =>
                challenges.find(c => c.id === id)?.tags.includes('photo')
            ).length;

            document.getElementById('completedStat').textContent = totalCompleted;
            document.getElementById('countriesStat').textContent = countries;
            document.getElementById('photosStat').textContent = photos;

            const percentage = Math.round((totalCompleted / totalChallenges) * 100);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressPercent').textContent = percentage + '%';

            // Check if all challenges are completed
            if (totalCompleted === totalChallenges && totalChallenges > 0) {
                // Check if we've shown the completion modal this session
                const hasShownCompletion = sessionStorage.getItem('completionModalShown');
                if (hasShownCompletion !== 'true') {
                    showCompletionModal(totalCompleted, countries, photos);
                    sessionStorage.setItem('completionModalShown', 'true');
                }
            }
        }

        // Show completion celebration modal
        function showCompletionModal(challenges, countries, photos) {
            // Update the stats in the modal
            document.getElementById('completionChallenges').textContent = challenges;
            document.getElementById('completionCountries').textContent = countries;
            document.getElementById('completionPhotos').textContent = photos;

            // Show the modal
            document.getElementById('completionModal').style.display = 'flex';

            // Create confetti animation
            createConfetti();
        }

        // Close completion modal
        function closeCompletionModal() {
            document.getElementById('completionModal').style.display = 'none';
            // Clear confetti
            const container = document.getElementById('confettiContainer');
            if (container) {
                container.innerHTML = '';
            }
        }

        // Create confetti animation
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            if (!container) return;

            container.innerHTML = ''; // Clear existing confetti

            const colors = ['#6B5B95', '#FF6B35', '#F4A261', '#52B788', '#FFF5EB'];
            const confettiCount = 100;
            const maxDelaySeconds = 1;
            const minDurationSeconds = 3;
            const maxDurationSeconds = 5;

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.setProperty('--confetti-x', (Math.random() - 0.5) * 200 + 'px');
                confetti.style.animationDelay = Math.random() * maxDelaySeconds + 's';
                confetti.style.animationDuration = (Math.random() * (maxDurationSeconds - minDurationSeconds) + minDurationSeconds) + 's';
                container.appendChild(confetti);
            }
        }

        // Show celebration modal
        function showCelebration(message) {
            document.getElementById('celebrationText').textContent = message;
            document.getElementById('celebrationModal').style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('celebrationModal').style.display = 'none';
        }

        // Show stats modal
        function showStatsModal(type) {
            const modalEmoji = document.getElementById('statsModalEmoji');
            const modalTitle = document.getElementById('statsModalTitle');
            const modalContent = document.getElementById('statsModalContent');

            let content = '';

            if (type === 'completed') {
                modalEmoji.textContent = '‚úÖ';
                modalTitle.textContent = 'Completed Challenges';

                const completedChallenges = challenges.filter(c => completed.includes(c.id));

                if (completedChallenges.length === 0) {
                    content = '<p style="color: #999; text-align: center; padding: 40px;">No challenges completed yet. Start your adventure!</p>';
                } else {
                    completedChallenges.forEach(challenge => {
                        content += `
                            <div class="stats-item completed">
                                <div class="stats-item-info">
                                    <div class="stats-item-emoji">${challenge.emoji}</div>
                                    <div class="stats-item-text">
                                        <div class="stats-item-name">${challenge.name}</div>
                                        <div class="stats-item-detail">${challenge.time}</div>
                                    </div>
                                </div>
                                <div class="stats-item-status">‚úì</div>
                            </div>
                        `;
                    });
                }
            } else if (type === 'countries') {
                modalEmoji.textContent = 'üåç';
                modalTitle.textContent = 'Countries Progress';

                // Get unique countries from challenges with drink tag
                const countryMap = new Map();
                challenges.forEach(challenge => {
                    if (challenge.country && challenge.tags.includes('drink')) {
                        if (!countryMap.has(challenge.country)) {
                            countryMap.set(challenge.country, {
                                name: challenge.country,
                                challenge: challenge,
                                completed: completed.includes(challenge.id)
                            });
                        }
                    }
                });

                const countryNames = {
                    'mexico': 'üá≤üáΩ Mexico',
                    'norway': 'üá≥üá¥ Norway',
                    'china': 'üá®üá≥ China',
                    'germany': 'üá©üá™ Germany',
                    'italy': 'üáÆüáπ Italy',
                    'usa': 'üá∫üá∏ USA',
                    'japan': 'üáØüáµ Japan',
                    'morocco': 'üá≤üá¶ Morocco',
                    'france': 'üá´üá∑ France',
                    'uk': 'üá¨üáß United Kingdom',
                    'canada': 'üá®üá¶ Canada'
                };

                countryMap.forEach((data, country) => {
                    const isCompleted = data.completed;
                    const displayName = countryNames[country] || country;
                    content += `
                        <div class="stats-item ${isCompleted ? 'completed' : 'pending'}">
                            <div class="stats-item-info">
                                <div class="stats-item-emoji">${data.challenge.emoji}</div>
                                <div class="stats-item-text">
                                    <div class="stats-item-name">${displayName}</div>
                                    <div class="stats-item-detail">${data.challenge.name}</div>
                                </div>
                            </div>
                            <div class="stats-item-status">${isCompleted ? '‚úì' : '‚óã'}</div>
                        </div>
                    `;
                });
            } else if (type === 'photos') {
                modalEmoji.textContent = 'üì∏';
                modalTitle.textContent = 'Photos Progress';

                const photoChallenges = challenges.filter(c => c.tags.includes('photo'));

                photoChallenges.forEach(challenge => {
                    const isCompleted = completed.includes(challenge.id);
                    content += `
                        <div class="stats-item ${isCompleted ? 'completed' : 'pending'}">
                            <div class="stats-item-info">
                                <div class="stats-item-emoji">${challenge.emoji}</div>
                                <div class="stats-item-text">
                                    <div class="stats-item-name">${challenge.name}</div>
                                    <div class="stats-item-detail">${challenge.time}</div>
                                </div>
                            </div>
                            <div class="stats-item-status">${isCompleted ? '‚úì' : '‚óã'}</div>
                        </div>
                    `;
                });
            }

            modalContent.innerHTML = content;
            document.getElementById('statsModal').style.display = 'flex';
        }

        // Close stats modal
        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

            if (tab === 'map') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('mapTab').classList.add('active');
                // Only trigger resize if map exists
                if (typeof google !== 'undefined' && google.maps && map) {
                    google.maps.event.trigger(map, 'resize');
                }
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('listTab').classList.add('active');
            }
        }

        // Navigate to a specific challenge on the map
        function navigateToChallenge(index) {
            const challenge = challenges[index];
            if (challenge.lat && challenge.lng) {
                // Check if map is available
                if (!map || !markers || markers.length === 0) {
                    alert('Map is not available. The map feature requires a valid Google Maps API key in config.js.');
                    return;
                }

                // Switch to map tab
                switchTab('map');

                // Pan to the challenge location and zoom
                map.panTo({ lat: challenge.lat, lng: challenge.lng });
                map.setZoom(18);

                // Open the info window for this marker
                if (markers[index]) {
                    markers.forEach(m => m.infoWindow.close());
                    markers[index].infoWindow.open(map, markers[index].marker);
                }
            }
        }

        // Map controls
        function focusOnNextStop() {
            const nextIndex = completed.length;
            if (nextIndex < challenges.length) {
                const next = challenges[nextIndex];
                if (next.lat && next.lng) {
                    map.panTo({ lat: next.lat, lng: next.lng });
                    map.setZoom(18);
                    markers[nextIndex].infoWindow.open(map, markers[nextIndex].marker);
                }
            }
        }

        function showAllMarkers() {
            const bounds = new google.maps.LatLngBounds();
            challenges.forEach(c => {
                if (c.lat && c.lng) {
                    bounds.extend({ lat: c.lat, lng: c.lng });
                }
            });
            map.fitBounds(bounds);
        }

        function focusOnReservations() {
            const reservations = challenges.filter(c => c.tags.includes('reservation'));
            const bounds = new google.maps.LatLngBounds();
            reservations.forEach(c => {
                if (c.lat && c.lng) {
                    bounds.extend({ lat: c.lat, lng: c.lng });
                }
            });
            map.fitBounds(bounds);
        }

        // Reset all progress
        async function resetAll() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone!')) {
                completed = [];
                localStorage.removeItem('vincentChallenges');
                if (syncEnabled && db) {
                    await db.ref('session/completed').set([]);
                    // onValue listener will trigger re-render
                } else {
                    init();
                }
            }
        }

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>
